## 线程概念和多线程模型

### 引入线程的目的 

- 为了减小程序并发执行时所付出的**时空开销**，提高程序执行的**并发**程度

- 线程，**轻量级进程**，一个基本的CPU执行单元，也是程序执行的最小单元

- 线程是进程中的**一个实体**，是被系统**独立调度和分派**的基本单位，自己**不拥有资源**

### 线程的堆和栈

- 堆(heap)是每个线程共有的空间，分全局堆和局部堆

#### 全局堆

- 全局堆就是所有没有分配的空间

#### 局部堆

- 局部堆就是已经为用户分配的空间

- **堆**在操作系统对**进程初始化**的时候分配，运行过程中也可以向系统要额外的堆，用完后还给操作系统，要不然就是**内存泄漏**

#### 线程的栈

- 栈是每个线程**独有**的，用来保存运行状态和局部自动变量

- 栈在**线程创建的时候初始化**，**每个线程的栈互相独立**

- 栈是Thread-safe

- 操作系统在切换线程的时候会**自动的切换栈**，就是切换SS/ESP寄存器

- 栈空间不需要在高级语言里面显式的分配和释放

### 线程与进程的比较

#### 调度

- 线程是**独立调度**的基本单位，进程是**拥有资源**的基本单位

- 同一进程中进行线程切换，不会引起进程切换；不同进程中线程切换，会引起进程切换

#### 拥有资源

- 线程只拥有**必不可少的一点资源**，切换线程时空开销小

#### 并发性能

- 多线程之间也可以进行并发，提高并发性，提高系统吞吐量

#### 系统开销

- 创建或撤销进程，都要**分配或回收资源**，线程切换只需要保存和设置少量寄存器内容

#### 系统空间和其它资源

- **进程**的地址空间之间**相互独立**

- 同一进程各线程间**共享**进程资源

- 各线程共享进程的虚拟地址空间

#### 通信

- 进程间通信(IPC)需要**进程同步**和**互斥手段**的辅助，保证数据一致性，线程间可以**读/写进程数据段**

#### 稳定性

- 线程稳定性差，因为**一个线程崩溃导致线程属于的进程崩溃**

### 线程的属性

- 线程是**轻型实体**，不拥有系统资源

- 不同线程可以执行相同的程序

- 同一进程中的**各个线程共享**该进程所拥有的资源

- 线程是处理机独立调度单位，多个线程可以并发执行

- 一个线程被创建后便开始了它的声明周期

### 线程的实现方式

用户级线程 & 内核级线程

![用户级线程和内核级线程](https://github.com/YC-L/Postgraduate-examination/blob/Operating-System/imgs/%E7%94%A8%E6%88%B7%E7%BA%A7%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%86%85%E6%A0%B8%E7%BA%A7%E7%BA%BF%E7%A8%8B.png "用户级线程和内核级线程")

### 多线程模型

- 多对一模型，将**多个用户级线程映射到一个内核级线程**，线程管理在用户空间完成效率高，但若内核阻塞，**整个进程**都会被阻塞

- 一对一模型，将**每个用户级线程映射到一个内核级线程**，并发能力强，但创建线程开销大

- 多对多模型，将**n个用户级线程映射到m各内核级线程**上，要求 m<=n

### 多线程优点

- 无需跨进程边界

- 程序逻辑和控制方式**简单**

- 所有线程可以**直接共享**内存和变量

- 线程方式**消耗的总资源**比进程方式**少**

### 多线程缺点

- 每个线程与主程序**共用地址空间**，受限于2GB地址空间

- 线程之间的**同步和加锁控制麻烦**

- 一个线程的**崩溃**可能影响到**整个程序的稳定性**

- 到达一定的线程数程度后，即使**再增加CPU也无法提高性能**

- 线程能够提高的总性能**有限**，线程增多之后，线程**调度复杂**，**占用CPU**较多

### 多进程优点

- 每个进程互相独立，不影响主程序的**稳定**性，子进程崩溃没关系

- 通过**增加CPU**，就可以**容易扩充性能**

- 可以尽量**减少线程加锁/解锁的影响**，极大提高性能，就算是线程运行的模块算法效率低也没关系 

- 每个子进程都有2GB地址空间和相关资源，总体能够达到的**性能上限非常大**

### 多线程缺点：

- 逻辑控制复杂，需要和主程序交

- 需要跨进程边界，如果有大数据量传送，切换进程消耗资源，适合**小数据量传送、密集运算** 

- 多进程调度**开销比较大**









