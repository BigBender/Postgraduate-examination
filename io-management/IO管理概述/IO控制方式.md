## I/O控制方式

设备管理的主要任务之一，控制设备和内存或处理机之间的数据传送
**
外围设备和内存之间的IO控制方式**

### 程序直接控制方式

![image](https://github.com/YC-L/Postgraduate-examination/blob/Operating-System/imgs/Program-direct-control.png)

从外部设备设备读取数据到存储器

每次读一个字的数据，每读入一个字，CPU需要对外设状态进行循环检查，确定该字在IO控制器的数据寄存器中

**由于CPU的高速性和I/O设备的低速性**

致使CPU大部分时间处于**等待**I/O设备的状态，CPU资源极大浪费，工作效率低

### 中断驱动方式

![image](https://github.com/YC-L/Postgraduate-examination/blob/Operating-System/imgs/Interrupt-drive-mode.png)

允许IO设备**主动打断**CPU的运行并请求服务，从而"**解放**"CPU

使得向IO控制器发送读命令后可以**继续做**其他工作

#### 从IO控制器角度来看

- IO控制器从CPU接收一个读命令，然后从外围设备读取数据

- 一旦**数据读入**到该IO控制器的数据寄存器，通过**控制线**给CPU**发出一个中断信号**
</br>表示数据准备好，等待CPU请求

- IO控制器**等待**CPU发出**取数据**的请求后，将数据放到**数据总线**，传到CPU的寄存器
</br>至此，IO操作完成，IO控制器可开始下一次IO操作

#### 从CPU角度来看

- CPU发出**读命令**，然后**保存当前运行程序的上下文**，专区执行其他程序

- 在每个指令周期的末尾，**CPU检查中断**

- 当有来自IO控制器的中断时，CPU**保存当前正在运行程序的上下文**，转去执行**中断处理程序**处理该中断

- CPU从IO控制器读**一个字**的数据传*送到寄存器*，并**存入主存**

- CPU恢复发出IO命令的**程序的上下文**，然后继续运行

中断驱动方式比程序直接控制方式**有效**

由于数据中的每个字在**存储器与IO控制器**之间的传输都必须经过CPU，到这了中断驱动方式仍然消耗较多CPU时间

### DMA方式

![image](https://github.com/YC-L/Postgraduate-examination/blob/Operating-System/imgs/DMA.png)

DMA的基本思想是在IO设备和内存之间开辟直接的数据交换通路，彻底"解放"CPU

在I/O设备和内存之间**开辟直接数据通路**，彻底解放CPU

- 基本单位是**数据块**

- 所传送的数据，从设备**直接**送入内存或者相反

- 仅在传送一个或多个数据块的开始和结束，需要CPU干预，整块数据的传送是在**DMA控制器的控制下完成**

![image](https://github.com/YC-L/Postgraduate-examination/blob/Operating-System/imgs/DMA-controller-composition.png)

DMA控制器

#### 工作方式

- CPU接收到IO设备的DMA请求时，它给**IO控制器发出一条命令**，启动DMA控制器，**然后继续其他工作**

- CPU就把控制操作委托给DMA控制器，DMA控制器直接与存储器交互，传送整个数据块，每次传送一个字
</br>**整个过程不需要CPU参与**

- 传送完成后，DMA控制器发送一个中断信号给处理器

只有在**传送开始和结束时**才需要**CPU参与**

#### 寄存器

为了**实现**主机和控制器之间成块数据的**直接交换**，必须在DMA控制器设置如下四类寄存器

- 命令/状态寄存器(CR)：用于接收从CPU发来的**IO命令**或**有关控制信息**，或**设备状态**

- 内存地址寄存器(MAR)：在输入时，它存放把数据从设备传送到内存的起始**目标地址**；
</br>在输出时，它存放由内存到设备的内存**源地址**

- 数据寄存器(DR)：用于**暂存**从设备到内存，或从内存到设备的数据

- 数据计数器(DC)：存放本次要**传送的字节数**

#### DMA控制方式与中断驱动方式的主要区别

- 中断驱动方式在**每个数据传输时**都需要中断CPU
</br>而DMA控制方式则是在所要求**传送的一批数据全部传送结束**时才中断CPU

- 中断驱动方式数据传送是在中断处理时由CPU控制完成的，DMA控制方式是在DMA控制器控制下完成

![I/O控制方式](https://github.com/YC-L/Postgraduate-examination/blob/Operating-System/imgs/IO%E6%8E%A7%E5%88%B6%E6%96%B9%E5%BC%8F.png "I/O控制方式")

### 通道控制方式

- IO通道是指**专门负责**输入/输出的**处理机**

- IO通道是DMA方式的发展，它可以进一步减少CPU的干预

- 把对**一个数据块**的读写单位的干预减少为对**一组数据块**读写及有关控制和管理为单位的干预

- 可以实现CPU、通道和I/O设备的**三者并行**操作，从而提高整个系统的资源利用率

#### IO通道与一般处理机的区别

- 通道指令的类型单一，**没有**自己的内存

- 通道执行的**通道程序**放在主机的**内存**中，**通道与CPU共享内存**

#### IO通道与DMA方式的区别

- DMA方式需要**CPU控制**传输的**数据块大小**、传输的**内存位置**，而通道方式这些信息由**通道控制**的

- 每个DMA控制器对应**一台设备**与内存传递数据，而一个通道可以控制**多台设备**与内存的数据交换

### 裁缝铺的比喻

- 程序直接控制：裁缝不联系客户，客户每隔一段时间取裁缝店看裁缝衣服做好没有

- 中断驱动方式：裁缝有客户联系方式，每完成一件衣服，给客户打一个电话，让客户去拿

- DMA：客户花钱雇了一个秘书，裁缝和秘书直接联系，当每处理100件衣服，秘书给客户报告一次

- 通道方式：秘书拥有更高的自主权，可以决定衣服放哪里，决定报告前处理衣服的数量，而且可以和多个裁缝沟通






