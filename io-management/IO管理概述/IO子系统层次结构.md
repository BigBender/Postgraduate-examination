## I/O子系统的层次结构

### I/O软件的总体设计目标是高效性和通用性

- 高效性是要确保I/O设备与CPU的**并发性**，以提高资源的利用率

- 通用性是指尽可能地提供简单抽象、清晰而统一的接口，采用**统一标准**的方法，来管理所有的设备及所需的I/O操作

### I/O软件应达到的目标

#### 与具体设备无关

- 程序员只要知道如何使用I/O硬件资源完成所需的操作，而无需了解设备的有关具体实现细节

- I/O软件屏蔽设备的具体细节，向高层软件提供抽象的逻辑设备，并完成逻辑设备到物理设备的映射

#### 统一命令

- 系统中对各类不同物理设备采取预先设计的、统一的逻辑名称，所有软件以逻辑名访问设备，可能同一逻辑名在不同情况下对应不同物理设备

#### 对错误的处理

- I/O错误尽可能由接近硬件的低层软件处理，不让高层软件感知

#### 缓冲技术

#### 设备的分配和释放

#### I/O控制方式

- 对于不同的设备选择不同的I/O控制方式（程序I/O、中断、DMA、通道）

### IO软件层次结构

- 为了使复杂的IO软件具有清晰的结构，良好的可移植性和适应性，在IO软件中普遍采用**层次式结构**

- 每一层都**利用其下层提供的服务**，完成IO功能的某些子功能，并屏蔽实现细节，**向高层提供服务**

- 只要层次间接口不变，对**某一层次的软件修改不会**引起下层或高层代码变更

![I/O层次结构](https://github.com/YC-L/Postgraduate-examination/blob/Operating-System/imgs/IO%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84.png "I/O层次结构") 

### 用户层I/O软件

- 实现与**用户交互**的接口，用户直接调用用户层提供的与IO相关库函数，对设备进行操作

- 用户层软件必须通过一组**系统调用**来获取操作系统服务

### 设备独立性软件(设备无关层)

- 实现**用户程序与设备驱动器**的统一接口、设备命令、设备保护以及设备分配与释放

- 同时为设备管理和数据传送**提供必要的存储空间**

#### 设备无关性(设备独立性)

- 设备独立性指除了直接与设备打交道的底层软件之外，其它部分的软件并不依赖于硬件

- 可以提高软件的设计效率

- 使得**应用程序独立于具体使用的物理设备**

- 在应用程序中，使用逻辑设备名请求使用某类设备

- 在系统实际执行时，必须将逻辑设备名**映射**成物理设备名使用

#### 逻辑设备名的好处

- 增加设备分配的灵活性

- 易于实现IO重定向，所谓重定向，是指用于IO操作的设备可以更换，而不改变应用程序

#### 独立性软件

- 为了实现设备独立性，必须**在驱动程序之上**设置一层设备独立性软件

#### 独立性软件功能

##### 执行所有设备的公有操作

- 设备分配与回收

- 逻辑设备名映射为物理设备名

- 设备保护，禁止用户直接访问

- 缓冲管理

- 差错控制

- 提供独立于设备的大小统一的逻辑块

- 屏蔽设备之间信息交换单位大小和传输速率的差异

##### 向用户层(文件层)提供统一接口

- 无论何种设备，向用户所提供的接口应该是相同的

#### 逻辑设备名到物理设备名映射的实现

- 逻辑设备表（LUT）

- 当进程用逻辑设备名请求I/O设备时，系统为它分配相应的物理设备，并在LUT中建立一个表目

##### LUT的设置可采用两种方式

- 整个系统一张，不能有相同逻辑设备名

- 每个用户一张，放入PCB中 

### 设备驱动程序

- 向上层用户程序提供一组标准接口，设备具体差别被设备驱动程序所封装，**接收上层软件发来的抽象IO要求**

- **检查用户I/O请求的合法性**，了解设备的状态，传递有关参数，设置设备的工作方式

- 发出I/O命令，若设备空闲则启动。若设备忙，则将请求者的请求块挂在设备队列上
</br>与硬件直接相关，负责**具体实现**系统对设备发出操作指令，驱动I/O设备工作的驱动程序

- 每一类设备设置一个设备驱动程序，它是**IO进程**与**设备控制器**之间的**通信程序**，以**进程形式**存在

- 及时响应通道或控制器发来的中断请求，调用相应的中断处理程序，对于设置有通道的，自动构成通道程序

#### 设备处理方式

- 作为**应用进程**的一部分执行：与程序控制I/O相对应，难以对外设发出的中断作实时响

- 作为**系统进程**执行：为每类设备设置一个进程；或整个系统设置一个I/O进程，负责对各类设备的I/O进程的管理；也可设置一个输入进程和一个输出进程

- 不设进程，作为**OS核心中的设备驱动程序**，供用户或系统进程调用

#### 设备驱动程序的特点

- 设备驱动程序是在I/O请求进程与设备控制器之间的桥梁，中转数据和控制

- 设备驱动程序与I/O设备特性、控制方式及硬件密切相关，一般由厂商提供

- **向上屏蔽设备细节**：不同类型设备通常其设备驱动程序接口不同，同类设备的接口相同。因此，同类设备的不同型号，只要更换设备驱动程序则可由OS使用

- 驱动程序**允许可重入**，一个正在运行的驱动程序可以被再次调用。

### 中断处理程序

- 用于**保存**被中断进程的**CPU环境**，转入相应的中断处理机程序进行处理

- 处理完并**恢复**被中断进程的现场后，**返回**到被中断进程

- 对用户而言，应尽量加以屏蔽，应放在**操作系统底层**

#### 中断处理层主要任务

- 进程上下文切换

- 对处理中断信号源进行测试，读取设备状态和修改进程状态

### 硬件设备

- I/O设备包括一个机械部件和一个电子部件

- 电子部件称为设备控制器

- 机械部件是设备本身

### 设备控制器

- 为了便于上层软件的编制，设备控制器需要提供控制寄存器、状态寄存器和控制命令

- 实现设备控制功能，IO逻辑

#### 设备控制器与CPU的通信

- 设备控制器通过**寄存器与CPU通信**，某些计算机的寄存器**占用内存地址的一部分**，称为内存映像IO

- 某些计算机采用IO专用地址，寄存器**独立编址**

- 操作系统通过向控制器寄存器**写命令字**来执行IO功能

- 命令执行完毕后，控制器发出一个**中断信号**，操作系统**重新获得CPU的控制权**并检查执行结果

- CPU仍从控制器寄存器中读取信息来获得执行结果和设备的状态信息

#### 设备控制器主要功能

- **接收和识别**CPU或通道发来的命令

- **实现数据交换**，包括设备和控制器之间的数据传输

- 通过数据总线或通道，控制器和主存之间的数据传输

- 发现和记录设备及自身状态信息，供CPU处理使用

- 设备地址识别

#### 设备控制器的组成部分

![设备控制器](https://github.com/YC-L/Postgraduate-examination/blob/Operating-System/imgs/%E8%AE%BE%E5%A4%87%E6%8E%A7%E5%88%B6%E5%99%A8.png "设备控制器")

- 设备控制器与CPU接口
</br>该接口有三类信号线：数据线、地址线和控制线
</br>数据线通常与两类寄存器相链接：数据寄存器(存放从设备送来的输入或从CPU送来的输出数据)和控制/状态寄存器(存放从CPU送来的控制信息或设备的状态信息)

- 设备控制器与设备的接口
</br>设备控制器连接设备需要相应数量的接口
</br>一个接口连接一台设备，每个接口都存在数据、控制和状态三种类型信号

- IO控制逻辑，用于实现对设备的控制
</br>通过一组控制线与CPU交互，对CPU收到的IO命令进行译码
</br>CPU启动设备时，将启动命令发送给控制器，同时通过地址线把地址发送给控制器，由控制器的IO逻辑对地址译码，并对所选设备进行控制




