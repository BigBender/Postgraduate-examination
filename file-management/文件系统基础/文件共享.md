## 文件共享

使多个用户共享同一份文件，系统中只需**保留该文件的一个副本**

若系统不能提供共享功能，每个需要该文件的用户都要有各自的副本，会浪费存储空间

### 基于索引结点的共享方式(硬链接)

![image](https://github.com/YC-L/Postgraduate-examination/blob/Operating-System/imgs/Hard-link.png)

引用索引结点，将文件的物理地址及其他的文件树形等信息放在**索引结点**中，设置一个**链接计数器**count

表示链接到本索引结点上的用户目录项数目

当count=2，表示有连个用户链接到本文件上，即有两个用户共享此文件

只有当**count数为0**时，系统**才能删除**该文件

![image](https://github.com/YC-L/Postgraduate-examination/blob/Operating-System/imgs/Link-count-in-file-share.png)

用户B链接到文件上的前、后情况

### 利用符号链实现文件共享(软链接)

由系统创建一个LINK类型的新文件，只包含被链接文件的**路径名**，称为**符号链接**

只有**文件拥有者**才**拥有指向其索引结点的指针**，共享该文件的用户只拥有路径名，没指针

符号链可能会导致**多次读盘**，增加启动磁盘的频率

但是其有个优点，**网络共享**只需提供该文件所在机器的**网络地址**以及该机器中的**文件路径**即可

**硬链接和软链接**都是文件系统中的**静态共享**方法

文件系统中还存在着另外的共享需求，两个进程同时对同一个文件进行操作，称为**动态共享**

**硬链接**比软连接查找**速度块**

### 文件共享的语义

- 当多个用户共享同一个文件时，要精确定义读和写的语义，即如何解决一个进程在写文件，另一个进程同时在读同一个文件的情况

- UNIX系统中，共享语义定义为，读操作得到的是在其之前所有写操作的最终值

- 系统为所有操作维持了一个绝对的时间顺序。以保证UNIX语义。

- 在一个单处理机上，或共享主存的多处理机上，UNIX语义非常容易实现。读者－写者问题

#### 会晤语义

- 在分布式系统中，如果只有一个文件服务器，且客户机不缓存文件，UNIX语义容易实现。

- 实际上为了保证性能，客户机要缓存文件

- 可能出现一个客户机改变了自己Cache中的文件，另一个客户机从服务器上读到的是旧文件。

- 解决方法是**放松文件共享语义**，不再要求读操作看到所有先前的写操作结果

- 而是对一个打开文件的修改一开始**只对那个修改文件的进程可见**

- 仅当文件被关闭后，修改才为其他进程所见，此规则称为**会晤语义**

#### 使用会晤语义，当多个客户机同时修改一个文件时，解决方案

- 最终结果取决于谁最后关闭文件

- 最终结果随机

#### 分布式系统中，文件共享语义的另一种完全不同的解决方法是：不允许写文件，只能创建或读

- 避免了一个进程在写文件，另一个进程同时在读文件

- 创建文件是用一个**全新的但同名的文件替换原来的文件**

- **不允许改文件**，但**可以改目录**

#### 分布式系统中，处理文件共享的另一种方法是使用原子事务（atomic transactions）

- 系统保证所有事务操作中的文件调用按照严格顺序执行，不被任何其他并发事务打断

- 如银行系统，订票系统等
